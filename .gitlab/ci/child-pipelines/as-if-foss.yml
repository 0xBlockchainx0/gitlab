include:
  - local: .gitlab/ci/shared/frontend.yml
  - local: .gitlab/ci/shared/global.yml
  - local: .gitlab/ci/shared/qa.yml
  - local: .gitlab/ci/shared/rails.yml
  - local: .gitlab/ci/shared/rules.yml
  - local: .gitlab/ci/base.gitlab-ci.yml

workflow:
  rules:
    # If not GitLab.com, don't create a pipeline.
    - if: '$CI_SERVER_HOST != "gitlab.com"'
      when: never
    # If project isn't `gitlab-org/gitlab/gitlab` or `gitlab-org/security/gitlab`, don't create a pipeline.
    - if: '$CI_PROJECT_PATH != "gitlab-org/gitlab" && $CI_PROJECT_PATH != "gitlab-org/security/gitlab"'
      when: never
    # For merge requests, create a pipeline.
    - if: '$CI_MERGE_REQUEST_IID'
    # For `master` branch, create a pipeline (this includes on schedules, pushes, merges, etc.).
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

.as-if-foss:
  variables:
    FOSS_ONLY: '1'

hello-world:
  script:
    - echo $CI_SERVER_HOST
    - echo $CI_PROJECT_PATH
    - 'echo "hello world"'

#################
# Frontend jobs #
#################
compile-assets pull-push-cache as-if-foss:
  extends:
    - .compile-assets-metadata
    - .frontend:rules:default-frontend-jobs-as-if-foss
    - .as-if-foss
  cache:
    policy: pull-push
    key: "assets-compile:test:as-if-foss:v1"

compile-assets pull-cache as-if-foss:
  extends:
    - .compile-assets-metadata
    - .frontend:rules:default-frontend-jobs-as-if-foss
    - .as-if-foss
  cache:
    policy: pull
    key: "assets-compile:test:as-if-foss:v1"

frontend-fixtures-as-if-foss:
  extends:
    - .frontend-fixtures-base
    - .frontend:rules:default-frontend-jobs-as-if-foss
    - .as-if-foss
  needs:
    - project: $CI_PROJECT_PATH
      job: setup-test-env pg9
      ref: $CI_COMMIT_REF_NAME
    - project: $CI_PROJECT_PATH
      job: compile-assets pull-cache
      ref: $CI_COMMIT_REF_NAME

karma-as-if-foss:
  extends:
    - .karma-base
    - .frontend:rules:default-frontend-jobs-as-if-foss
    - .as-if-foss
  needs: ["frontend-fixtures-as-if-foss"]

jest-as-if-foss:
  extends:
    - .jest-base
    - .frontend:rules:default-frontend-jobs-as-if-foss
    - .as-if-foss
  needs: ["frontend-fixtures-as-if-foss"]
  cache:
    policy: pull

# ##############
# # Rails jobs #
# ##############
# .rspec-base-pg9-as-if-foss:
#   extends:
#     - .rspec-base-pg9
#     - .rails:rules:ee-only-as-if-foss
#     - .as-if-foss
#   needs:
#     # FIXME
#     # - project: $CI_PROJECT_PATH
#     #   job: setup-test-env pg9
#     #   ref: $CI_COMMIT_REF_NAME
#     - project: gitlab-org/gitlab
#       job: setup-test-env pg9
#       ref: 213944-run-as-if-foss-jobs-on-master-only
#     # FIXME
#     # - project: $CI_PROJECT_PATH
#     #   job: retrieve-tests-metadata
#     #   ref: $CI_COMMIT_REF_NAME
#     - project: gitlab-org/gitlab
#       job: retrieve-tests-metadata
#       ref: 213944-run-as-if-foss-jobs-on-master-only
#     - job: compile-assets pull-cache as-if-foss
#
# rspec migration pg9-as-if-foss:
#   extends:
#     - .rspec-base-pg9-as-if-foss
#     - .rspec-base-migration
#   parallel: 5
#
# rspec unit pg9-as-if-foss:
#   extends: .rspec-base-pg9-as-if-foss
#   parallel: 20
#
# rspec integration pg9-as-if-foss:
#   extends: .rspec-base-pg9-as-if-foss
#   parallel: 8
#
# rspec system pg9-as-if-foss:
#   extends: .rspec-base-pg9-as-if-foss
#   parallel: 24
#
# ###########
# # QA jobs #
# ###########
# qa:internal-as-if-foss:
#   extends:
#     - .qa-job-base
#     - .qa:rules:ee-only-as-if-foss
#     - .as-if-foss
#   script:
#     - bundle exec rspec
#
# qa:selectors-as-if-foss:
#   extends:
#     - qa:selectors
#     - .qa:rules:ee-only-as-if-foss
#     - .as-if-foss
