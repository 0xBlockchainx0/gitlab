.assets-compile-cache:
  cache:
    paths:
      - vendor/ruby/
      - public/assets/webpack/
      - assets-hash.txt
      - .yarn-cache/
      - tmp/cache/assets/sprockets
      - tmp/cache/babel-loader
      - tmp/cache/vue-loader
      - tmp/cache/webpack-dlls

.compile-assets-metadata:
  extends:
    - .default-retry
    - .default-before_script
    - .assets-compile-cache
  stage: prepare
  script:
    - node --version
    - retry yarn install --frozen-lockfile --cache-folder .yarn-cache --prefer-offline
    - free -m
    - time bin/rake gitlab:assets:compile > assets-compile.log 2>&1
    - scripts/clean-old-cached-assets
  variables:
    SETUP_DB: "false"
    # we override the max_old_space_size to prevent OOM errors
    NODE_OPTIONS: --max_old_space_size=3584
    WEBPACK_VENDOR_DLL: "true"
  cache:
    key: "assets-compile:test:v1"
  artifacts:
    expire_in: 7d
    paths:
      - node_modules
      - public/assets
      - assets-compile.log
    when: always

.frontend-fixtures-base:
  extends:
    - .default-retry
    - .default-cache
    - .default-before_script
    - .use-pg9
  stage: fixtures
  needs: ["setup-test-env pg9", "compile-assets pull-cache"]
  script:
    - date
    - scripts/gitaly-test-spawn
    - date
    - bundle exec rake frontend:fixtures
  artifacts:
    name: frontend-fixtures
    expire_in: 31d
    when: always
    paths:
      - node_modules
      - public/assets
      - tmp/tests/frontend/

.frontend-job-base:
  extends:
    - .default-retry
    - .default-cache
    - .default-before_script
  variables:
    USE_BUNDLE_INSTALL: "false"
    SETUP_DB: "false"
  stage: test

.karma-base:
  extends: .frontend-job-base
  variables:
    # we override the max_old_space_size to prevent OOM errors
    NODE_OPTIONS: --max_old_space_size=3584
  script:
    - export BABEL_ENV=coverage CHROME_LOG_FILE=chrome_debug.log
    - date
    - yarn karma

.jest-base:
  extends: .frontend-job-base
  script:
    - date
    - yarn jest --ci --coverage --testSequencer ./scripts/frontend/parallel_ci_sequencer.js
  cache:
    key: jest
    paths:
      - tmp/cache/jest/
    policy: pull-push
