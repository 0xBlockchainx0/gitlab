<script>
import { GlAvatar } from '@gitlab/ui';
import Icon from '~/vue_shared/components/icon.vue';

export default {
  name: 'VulnerabilitySeverity',
  components: {
    GlAvatar,
    Icon,
  },
  props: {
    section: {
      type: Object,
      required: true,
    },
  },
  data() {
    return {
      open: false,
    };
  },
  methods: {
    onClick() {
      this.open = !this.open;
    },
    projectClassName() {
      return `vulnerability-severity-grade-${this.section.severityGrade.toLowerCase()}`;
    },
    projectVulnerabilitiesCount(project) {
      let result = 0;
      this.section.severityLevelCategories.forEach(category => {
        if (typeof project[category + '_vulnerability_count'] === 'number') {
          result += project[category + '_vulnerability_count'];
        }
      });
      return result;
    },
  },
  computed: {
    isOpen() {
      const result = this.section.projects.length > 0 ? this.open : false;

      if (result) {
        this.$emit('clicked', this.section.severityGrade);
      }

      return result;
    },
  },
};
</script>

<template>
  <div class="vulnerability-severity" :class="{ 'is-open': isOpen }" @click="onClick">
    <div class="vulnerability-severity-toggle d-flex flex-row cursor-pointer">
      <gl-avatar
        class="vulnerability-severity-avatar align-self-center"
        :entity-name="section.severityGrade"
        shape="circle"
        :size="32"
        :style="{ backgroundColor: section.backgroundColor, color: section.textColor }"
      />
      <div class="ml-3 align-self-center">
        {{ section.projects.length + ' ' + n__('project', 'projects', section.projects.length) }}
      </div>
      <icon
        v-show="isOpen"
        name="chevron-up"
        :size="16"
        class="vulnerability-collapse-icon ml-auto mr-2 align-self-center"
      />
      <icon
        v-show="!isOpen"
        name="chevron-down"
        :size="16"
        class="vulnerability-collapse-icon ml-auto mr-2 align-self-center"
      />
    </div>
    <div v-show="isOpen" class="content">
      <div class="vulnerability-severity-label my-2">
        {{ section.severityLabel }}
      </div>
      <div class="d-flex flex-column">
        <div class="my-1" v-for="(project, index) in section.projects" :key="index">
          {{ project.name }}
          <div class="vulnerability-severity-subheader py-2" :class="projectClassName(project)">
            {{ projectVulnerabilitiesCount(project) }}
            {{ section.severityLevelLabel }}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style>
.vulnerability-severity {
  border-radius: 0.6em;
  color: #505050;
  display: block;
  overflow: hidden;
  text-align: left;
}

.vulnerability-severity.is-open .vulnerability-severity-toggle {
  font-weight: bold;
}

.vulnerability-severity-toggle {
  height: 32px;
}

.vulnerability-severity-avatar {
  font-weight: bold;
  border-width: 0;
}

.vulnerability-severity-label {
  color: #707070;
  font-size: 0.74rem;
}

.vulnerability-severity-subheader {
  font-size: 0.74rem;
}

.vulnerability-severity-grade-a {
  color: #197323;
}

.vulnerability-severity-grade-b {
  color: #2c2c2c;
}

.vulnerability-severity-grade-c {
  color: #6145df;
}

.vulnerability-severity-grade-d {
  color: #a44500;
}

.vulnerability-severity-grade-f {
  color: #c83919;
}
</style>
