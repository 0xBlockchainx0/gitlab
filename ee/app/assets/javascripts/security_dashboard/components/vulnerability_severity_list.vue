<script>
import { GlLink } from '@gitlab/ui';
import VulnerabilitySeverity from './vulnerability_severity.vue';

const SERVERITY_RATINGS = [
  {
    grade: 'F',
    label: 'Critical vulnerabilities present',
    levelLabel: 'critical',
    levelCategories: ['critical'],
    backgroundColor: '#f8e6e1',
    textColor: '#c83919',
    maxCritical: 1,
    maxHigh: 0,
    maxMedium: 0,
    maxLow: 0,
    maxUnknown: 0,
    isOpen: true,
  },
  {
    grade: 'D',
    label: 'High or unknown vulnerabilities present',
    levelLabel: 'high or unknown',
    levelCategories: ['high', 'unknown'],
    backgroundColor: '#fcf1de',
    textColor: '#a44500',
    maxCritical: 0,
    maxHigh: 1,
    maxMedium: 0,
    maxLow: 0,
    maxUnknown: 1,
    isOpen: false,
  },
  {
    grade: 'C',
    label: 'Medium vulnerabilities present',
    levelLabel: 'medium',
    levelCategories: ['medium'],
    backgroundColor: '#ece8fb',
    textColor: '#6145df',
    maxCritical: 0,
    maxHigh: 0,
    maxMedium: 1,
    maxLow: 0,
    maxUnknown: 0,
    isOpen: false,
  },
  {
    grade: 'B',
    label: 'Low vulnerabilities present',
    levelLabel: 'low',
    levelCategories: ['low'],
    backgroundColor: '#dfdfdf',
    textColor: '#2c2c2c',
    maxCritical: 0,
    maxHigh: 0,
    maxMedium: 0,
    maxLow: 1,
    maxUnknown: 0,
    isOpen: false,
  },
  {
    grade: 'A',
    label: 'No known vulnerabilities present',
    levelLabel: 'known',
    levelCategories: [],
    backgroundColor: '#e0f4e7',
    textColor: '#197323',
    maxCritical: 0,
    maxHigh: 0,
    maxMedium: 0,
    maxLow: 0,
    maxUnknown: 0,
    isOpen: false,
  },
];

export default {
  name: 'VulnerabilitySeverityList',
  components: {
    GlLink,
    VulnerabilitySeverity,
  },
  props: {
    helpUrl: {
      type: String,
      required: false,
      default: '',
    },
    projects: {
      type: Array,
      required: true,
      default: () => [],
    },
  },
  methods: {
    onClicked(value) {
      // FIXME: This needs to close any already-opened sections.
      // this.sections.forEach(section => {});
    },
  },
  computed: {
    sections() {
      return SERVERITY_RATINGS.map(severityRating => {
        // FIXME: Since the dashboard refactor, we have no projects unless they
        // have corresponding security reports. For getting the UX right we fall
        // back to fake data as a temporary measure. This needs to be removed
        // and we need to handle the emtpy state.
        // See: https://gitlab.com/gitlab-org/gitlab/commit/07a4d7d0378660a2383d8b97d6f94d1f98b30fa0
        let debugProjects = (this.projects.length) ? this.projects : [{"id":23,"description":"","name":"container-scanning","name_with_namespace":"Gitlab Org / container-scanning","path":"container-scanning","path_with_namespace":"gitlab-org/container-scanning","created_at":"2019-08-26T17:49:55.128Z","default_branch":"master","tag_list":[],"ssh_url_to_repo":"ssh://dietrichstein@localhost:2222/gitlab-org/container-scanning.git","http_url_to_repo":"http://ee.gitlab:3001/gitlab-org/container-scanning.git","web_url":"http://ee.gitlab:3001/gitlab-org/container-scanning","readme_url":"http://ee.gitlab:3001/gitlab-org/container-scanning/blob/master/README.md","avatar_url":null,"star_count":0,"forks_count":0,"last_activity_at":"2019-08-26T17:49:55.128Z","namespace":{"id":2,"name":"Gitlab Org","path":"gitlab-org","kind":"group","full_path":"gitlab-org","parent_id":null,"avatar_url":null,"web_url":"http://ee.gitlab:3001/groups/gitlab-org"},"_links":{"self":"http://ee.gitlab:3001/api/v4/projects/23","issues":"http://ee.gitlab:3001/api/v4/projects/23/issues","merge_requests":"http://ee.gitlab:3001/api/v4/projects/23/merge_requests","repo_branches":"http://ee.gitlab:3001/api/v4/projects/23/repository/branches","labels":"http://ee.gitlab:3001/api/v4/projects/23/labels","events":"http://ee.gitlab:3001/api/v4/projects/23/events","members":"http://ee.gitlab:3001/api/v4/projects/23/members"},"empty_repo":false,"archived":false,"visibility":"private","resolve_outdated_diff_discussions":false,"container_registry_enabled":true,"issues_enabled":true,"merge_requests_enabled":true,"wiki_enabled":true,"jobs_enabled":true,"snippets_enabled":true,"issues_access_level":"enabled","repository_access_level":"enabled","merge_requests_access_level":"enabled","wiki_access_level":"enabled","builds_access_level":"enabled","snippets_access_level":"enabled","shared_runners_enabled":true,"lfs_enabled":true,"creator_id":1,"import_status":"finished","open_issues_count":0,"ci_default_git_depth":50,"public_jobs":true,"build_timeout":3600,"auto_cancel_pending_pipelines":"enabled","build_coverage_regex":null,"ci_config_path":null,"shared_with_groups":[],"only_allow_merge_if_pipeline_succeeds":false,"request_access_enabled":false,"only_allow_merge_if_all_discussions_are_resolved":false,"printing_merge_request_link_enabled":true,"merge_method":"merge","auto_devops_enabled":true,"auto_devops_deploy_strategy":"continuous","repository_storage":"default","approvals_before_merge":0,"mirror":false,"external_authorization_classification_label":null,"packages_enabled":true},{"id":2,"description":"Eum dolorem voluptatem in doloremque beatae.","name":"Gitlab Shell","name_with_namespace":"Gitlab Org / Gitlab Shell","path":"gitlab-shell","path_with_namespace":"gitlab-org/gitlab-shell","created_at":"2019-06-27T05:40:47.085Z","default_branch":"master","tag_list":[],"ssh_url_to_repo":"ssh://dietrichstein@localhost:2222/gitlab-org/gitlab-shell.git","http_url_to_repo":"http://ee.gitlab:3001/gitlab-org/gitlab-shell.git","web_url":"http://ee.gitlab:3001/gitlab-org/gitlab-shell","readme_url":"http://ee.gitlab:3001/gitlab-org/gitlab-shell/blob/master/README.md","avatar_url":null,"star_count":0,"forks_count":0,"last_activity_at":"2019-06-27T05:40:47.085Z","namespace":{"id":2,"name":"Gitlab Org","path":"gitlab-org","kind":"group","full_path":"gitlab-org","parent_id":null,"avatar_url":null,"web_url":"http://ee.gitlab:3001/groups/gitlab-org"},"_links":{"self":"http://ee.gitlab:3001/api/v4/projects/2","issues":"http://ee.gitlab:3001/api/v4/projects/2/issues","merge_requests":"http://ee.gitlab:3001/api/v4/projects/2/merge_requests","repo_branches":"http://ee.gitlab:3001/api/v4/projects/2/repository/branches","labels":"http://ee.gitlab:3001/api/v4/projects/2/labels","events":"http://ee.gitlab:3001/api/v4/projects/2/events","members":"http://ee.gitlab:3001/api/v4/projects/2/members"},"empty_repo":false,"archived":false,"visibility":"private","resolve_outdated_diff_discussions":false,"container_registry_enabled":true,"issues_enabled":true,"merge_requests_enabled":true,"wiki_enabled":true,"jobs_enabled":true,"snippets_enabled":true,"issues_access_level":"enabled","repository_access_level":"enabled","merge_requests_access_level":"enabled","wiki_access_level":"enabled","builds_access_level":"enabled","snippets_access_level":"enabled","shared_runners_enabled":true,"lfs_enabled":true,"creator_id":1,"import_status":"finished","open_issues_count":13,"ci_default_git_depth":50,"public_jobs":true,"build_timeout":3600,"auto_cancel_pending_pipelines":"enabled","build_coverage_regex":null,"ci_config_path":null,"shared_with_groups":[],"only_allow_merge_if_pipeline_succeeds":false,"request_access_enabled":false,"only_allow_merge_if_all_discussions_are_resolved":false,"printing_merge_request_link_enabled":true,"merge_method":"merge","auto_devops_enabled":true,"auto_devops_deploy_strategy":"continuous","repository_storage":"default","approvals_before_merge":0,"mirror":false,"external_authorization_classification_label":null,"packages_enabled":true},{"id":1,"description":"Enim quibusdam adipisci quisquam quia.","name":"Gitlab Test","name_with_namespace":"Gitlab Org / Gitlab Test","path":"gitlab-test","path_with_namespace":"gitlab-org/gitlab-test","created_at":"2019-06-27T05:40:35.923Z","default_branch":"master","tag_list":[],"ssh_url_to_repo":"ssh://dietrichstein@localhost:2222/gitlab-org/gitlab-test.git","http_url_to_repo":"http://ee.gitlab:3001/gitlab-org/gitlab-test.git","web_url":"http://ee.gitlab:3001/gitlab-org/gitlab-test","readme_url":"http://ee.gitlab:3001/gitlab-org/gitlab-test/blob/master/README.md","avatar_url":null,"star_count":0,"forks_count":4,"last_activity_at":"2019-06-27T05:40:35.923Z","namespace":{"id":2,"name":"Gitlab Org","path":"gitlab-org","kind":"group","full_path":"gitlab-org","parent_id":null,"avatar_url":null,"web_url":"http://ee.gitlab:3001/groups/gitlab-org"},"_links":{"self":"http://ee.gitlab:3001/api/v4/projects/1","issues":"http://ee.gitlab:3001/api/v4/projects/1/issues","merge_requests":"http://ee.gitlab:3001/api/v4/projects/1/merge_requests","repo_branches":"http://ee.gitlab:3001/api/v4/projects/1/repository/branches","labels":"http://ee.gitlab:3001/api/v4/projects/1/labels","events":"http://ee.gitlab:3001/api/v4/projects/1/events","members":"http://ee.gitlab:3001/api/v4/projects/1/members"},"empty_repo":false,"archived":false,"visibility":"public","resolve_outdated_diff_discussions":false,"container_registry_enabled":true,"issues_enabled":true,"merge_requests_enabled":true,"wiki_enabled":true,"jobs_enabled":true,"snippets_enabled":true,"issues_access_level":"enabled","repository_access_level":"enabled","merge_requests_access_level":"enabled","wiki_access_level":"enabled","builds_access_level":"enabled","snippets_access_level":"enabled","shared_runners_enabled":true,"lfs_enabled":true,"creator_id":1,"import_status":"finished","open_issues_count":15,"ci_default_git_depth":50,"public_jobs":true,"build_timeout":3600,"auto_cancel_pending_pipelines":"enabled","build_coverage_regex":null,"ci_config_path":null,"shared_with_groups":[],"only_allow_merge_if_pipeline_succeeds":false,"request_access_enabled":false,"only_allow_merge_if_all_discussions_are_resolved":false,"printing_merge_request_link_enabled":true,"merge_method":"merge","auto_devops_enabled":true,"auto_devops_deploy_strategy":"continuous","repository_storage":"default","approvals_before_merge":0,"mirror":false,"external_authorization_classification_label":null,"packages_enabled":true},{"id":21,"description":"","name":"sast","name_with_namespace":"Gitlab Org / sast","path":"sast","path_with_namespace":"gitlab-org/sast","created_at":"2019-08-23T05:50:11.756Z","default_branch":"master","tag_list":[],"ssh_url_to_repo":"ssh://dietrichstein@localhost:2222/gitlab-org/sast.git","http_url_to_repo":"http://ee.gitlab:3001/gitlab-org/sast.git","web_url":"http://ee.gitlab:3001/gitlab-org/sast","readme_url":null,"avatar_url":null,"star_count":0,"forks_count":0,"last_activity_at":"2019-08-26T16:16:38.595Z","namespace":{"id":2,"name":"Gitlab Org","path":"gitlab-org","kind":"group","full_path":"gitlab-org","parent_id":null,"avatar_url":null,"web_url":"http://ee.gitlab:3001/groups/gitlab-org"},"_links":{"self":"http://ee.gitlab:3001/api/v4/projects/21","issues":"http://ee.gitlab:3001/api/v4/projects/21/issues","merge_requests":"http://ee.gitlab:3001/api/v4/projects/21/merge_requests","repo_branches":"http://ee.gitlab:3001/api/v4/projects/21/repository/branches","labels":"http://ee.gitlab:3001/api/v4/projects/21/labels","events":"http://ee.gitlab:3001/api/v4/projects/21/events","members":"http://ee.gitlab:3001/api/v4/projects/21/members"},"empty_repo":false,"archived":false,"visibility":"private","resolve_outdated_diff_discussions":false,"container_registry_enabled":true,"issues_enabled":true,"merge_requests_enabled":true,"wiki_enabled":true,"jobs_enabled":true,"snippets_enabled":true,"issues_access_level":"enabled","repository_access_level":"enabled","merge_requests_access_level":"enabled","wiki_access_level":"enabled","builds_access_level":"enabled","snippets_access_level":"enabled","shared_runners_enabled":true,"lfs_enabled":true,"creator_id":1,"import_status":"finished","open_issues_count":0,"ci_default_git_depth":50,"public_jobs":true,"build_timeout":3600,"auto_cancel_pending_pipelines":"enabled","build_coverage_regex":null,"ci_config_path":null,"shared_with_groups":[],"only_allow_merge_if_pipeline_succeeds":false,"request_access_enabled":false,"only_allow_merge_if_all_discussions_are_resolved":false,"printing_merge_request_link_enabled":true,"merge_method":"merge","auto_devops_enabled":true,"auto_devops_deploy_strategy":"continuous","repository_storage":"default","approvals_before_merge":0,"mirror":false,"external_authorization_classification_label":null,"packages_enabled":true}];

        // FIXME: We need these counts so we probably need to configure the
        // dedicated endpoint to replace this code.
        debugProjects.forEach(project => {
          if (typeof project.critical_vulnerability_count === 'undefined') {
            project.critical_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.high_vulnerability_count === 'undefined') {
            project.high_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.unknown_vulnerability_count === 'undefined') {
            project.unknown_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.medium_vulnerability_count === 'undefined') {
            project.medium_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.low_vulnerability_count === 'undefined') {
            project.low_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
        });

        const projectsByRating = debugProjects.filter(project => {
          return (
            (severityRating.grade === 'F' &&
              project.critical_vulnerability_count > 0 &&
              project.critical_vulnerability_count >= severityRating.maxCritical) ||
            (severityRating.grade === 'D' &&
              project.high_vulnerability_count > 0 &&
              project.high_vulnerability_count <= severityRating.maxHigh) ||
            (severityRating.grade === 'D' &&
              project.unknown_vulnerability_count > 0 &&
              project.unknown_vulnerability_count <= severityRating.maxUnknown) ||
            (severityRating.grade === 'C' &&
              project.medium_vulnerability_count > 0 &&
              project.medium_vulnerability_count <= severityRating.maxMedium) ||
            (severityRating.grade === 'B' &&
              project.low_vulnerability_count > 0 &&
              project.low_vulnerability_count <= severityRating.maxLow) ||
            (severityRating.grade === 'A' &&
              project.critical_vulnerability_count === 0 &&
              project.high_vulnerability_count === 0 &&
              project.unknown_vulnerability_count === 0 &&
              project.medium_vulnerability_count === 0 &&
              project.low_vulnerability_count === 0)
          );
        });

        return {
          isOpen: severityRating.isOpen,
          textColor: severityRating.textColor,
          backgroundColor: severityRating.backgroundColor,
          severityLevelLabel: severityRating.levelLabel,
          severityLevelCategories: severityRating.levelCategories,
          severityGrade: severityRating.grade,
          severityLabel: severityRating.label,
          projects: projectsByRating,
        };
      });
    },
    hasHelpURL() {
      return this.helpUrl.length > 0;
    },
  },
};
</script>

<template>
  <section class="vulnerability-severity-list border rounded">
    <header>
      <h4 class="mt-0 mb-1 px-3 pt-3">
        {{ __('Project security status') }}
        <span v-if="hasHelpURL">
          <gl-link :href="helpUrl" target="_blank" rel="noopener noreferrer nofollow">
            <i class="fa fa-question-circle" aria-hidden="true"></i>
          </gl-link>
        </span>
      </h4>
      <p class="text-secondary my-0 px-3 pb-3">
        {{ __('Projects scored by vulnerability severity type detected.') }}
      </p>
    </header>
    <div class="list-section mx-3 py-3" v-for="(section, i) in sections" :key="i">
      <vulnerability-severity :section="section" @clicked="onClicked" />
    </div>
  </section>
</template>

<style>
.vulnerability-severity-list header {
  border-bottom: 1px solid #d6d6d6;
}
</style>
