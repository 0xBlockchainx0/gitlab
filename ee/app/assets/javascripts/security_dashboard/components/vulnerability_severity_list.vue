<script>
import { GlLink } from '@gitlab/ui';
import VulnerabilitySeverity from './vulnerability_severity.vue';

const SERVERITY_RATINGS = [
  {
    grade: 'F',
    label: 'Critical vulnerabilities present',
    levelLabel: 'critical',
    levelCategories: ['critical'],
    backgroundColor: '#f8e6e1',
    textColor: '#c83919',
    maxCritical: 1,
    maxHigh: 0,
    maxMedium: 0,
    maxLow: 0,
    maxUnknown: 0,
    isOpen: true,
  },
  {
    grade: 'D',
    label: 'High or unknown vulnerabilities present',
    levelLabel: 'high or unknown',
    levelCategories: ['high', 'unknown'],
    backgroundColor: '#fcf1de',
    textColor: '#a44500',
    maxCritical: 0,
    maxHigh: 1,
    maxMedium: 0,
    maxLow: 0,
    maxUnknown: 1,
    isOpen: false,
  },
  {
    grade: 'C',
    label: 'Medium vulnerabilities present',
    levelLabel: 'medium',
    levelCategories: ['medium'],
    backgroundColor: '#ece8fb',
    textColor: '#6145df',
    maxCritical: 0,
    maxHigh: 0,
    maxMedium: 1,
    maxLow: 0,
    maxUnknown: 0,
    isOpen: false,
  },
  {
    grade: 'B',
    label: 'Low vulnerabilities present',
    levelLabel: 'low',
    levelCategories: ['low'],
    backgroundColor: '#dfdfdf',
    textColor: '#2c2c2c',
    maxCritical: 0,
    maxHigh: 0,
    maxMedium: 0,
    maxLow: 1,
    maxUnknown: 0,
    isOpen: false,
  },
  {
    grade: 'A',
    label: 'No known vulnerabilities present',
    levelLabel: 'known',
    levelCategories: [],
    backgroundColor: '#e0f4e7',
    textColor: '#197323',
    maxCritical: 0,
    maxHigh: 0,
    maxMedium: 0,
    maxLow: 0,
    maxUnknown: 0,
    isOpen: false,
  },
];

export default {
  name: 'VulnerabilitySeverityList',
  components: {
    GlLink,
    VulnerabilitySeverity,
  },
  props: {
    helpUrl: {
      type: String,
      required: false,
      default: '',
    },
    projects: {
      type: Array,
      required: true,
      default: () => [],
    },
  },
  methods: {
    onClicked(value) {
      console.log('onClicked', value);
      this.sections.forEach(section => {
        console.log('section', section);
      });
    },
  },
  computed: {
    sections() {
      return SERVERITY_RATINGS.map(severityRating => {
        let debugProjects = this.projects;
        debugProjects.forEach(project => {
          if (typeof project.critical_vulnerability_count === 'undefined') {
            project.critical_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.high_vulnerability_count === 'undefined') {
            project.high_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.unknown_vulnerability_count === 'undefined') {
            project.unknown_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.medium_vulnerability_count === 'undefined') {
            project.medium_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
          if (typeof project.low_vulnerability_count === 'undefined') {
            project.low_vulnerability_count = Math.floor(Math.random() * Math.floor(10));
          }
        });

        const projectsByRating = debugProjects.filter(project => {
          return (
            (severityRating.grade === 'F' &&
              project.critical_vulnerability_count > 0 &&
              project.critical_vulnerability_count >= severityRating.maxCritical) ||
            (severityRating.grade === 'D' &&
              project.high_vulnerability_count > 0 &&
              project.high_vulnerability_count <= severityRating.maxHigh) ||
            (severityRating.grade === 'D' &&
              project.unknown_vulnerability_count > 0 &&
              project.unknown_vulnerability_count <= severityRating.maxUnknown) ||
            (severityRating.grade === 'C' &&
              project.medium_vulnerability_count > 0 &&
              project.medium_vulnerability_count <= severityRating.maxMedium) ||
            (severityRating.grade === 'B' &&
              project.low_vulnerability_count > 0 &&
              project.low_vulnerability_count <= severityRating.maxLow) ||
            (severityRating.grade === 'A' &&
              project.critical_vulnerability_count === 0 &&
              project.high_vulnerability_count === 0 &&
              project.unknown_vulnerability_count === 0 &&
              project.medium_vulnerability_count === 0 &&
              project.low_vulnerability_count === 0)
          );
        });

        return {
          isOpen: severityRating.isOpen,
          textColor: severityRating.textColor,
          backgroundColor: severityRating.backgroundColor,
          severityLevelLabel: severityRating.levelLabel,
          severityLevelCategories: severityRating.levelCategories,
          severityGrade: severityRating.grade,
          severityLabel: severityRating.label,
          projects: projectsByRating,
        };
      });
    },
    hasHelpURL() {
      return this.helpUrl.length > 0;
    },
  },
};
</script>

<template>
  <div class="vulnerability-severity-list d-flex flex-column">
    <div class="list-header p-0">
      <h4 class="mx-3 mt-3 mb-1">
        {{ __('Project security status') }}
        <span v-if="hasHelpURL">
          <gl-link :href="helpUrl" target="_blank" rel="noopener noreferrer nofollow">
            <i class="fa fa-question-circle" aria-hidden="true"></i>
          </gl-link>
        </span>
      </h4>
      <p class="list-subheader mx-3">Projects scored by vulnerability severity type detected.</p>
    </div>
    <div class="list-section mx-3 py-3" v-for="(section, i) in sections" :key="i">
      <vulnerability-severity :section="section" @clicked="onClicked" />
    </div>
  </div>
</template>

<style>
.vulnerability-severity-list {
  display: block;
  border-radius: 3px;
  border: 1px solid #d6d6d6;

  /* @TODO: Remove me! */
  width: 448px;
  margin-top: 3px;
  margin-bottom: 3px;
}

.vulnerability-severity-list .list-header {
  border-bottom: 1px solid #d6d6d6;
}

.vulnerability-severity-list .list-header h4 {
  font-size: 1rem;
}

.vulnerability-severity-list .list-subheader {
  color: #707070;
  font-size: 0.74rem;
}

.vulnerability-severity-list .list-section:not(:last-child) {
  border-bottom: 1px solid #e2e2e2;
}

.vulnerability-severity-list ul.gl-accordion {
  list-style: none;
  margin: 0;
  padding: 0;
}
</style>
