# frozen_string_literal: true

module Types
  class VulnerabilityType < BaseObject
    include GrapePathHelpers::NamedRouteMatcher

    graphql_name 'Vulnerability'
    description 'Represents a vulnerability.'

    authorize :read_vulnerability

    field :id, GraphQL::ID_TYPE, null: false,
          description: 'GraphQL ID of the vulnerability'

    field :title, GraphQL::STRING_TYPE, null: true,
          description: 'Title of the vulnerability'

    field :description, GraphQL::STRING_TYPE, null: true,
          description: 'Description of the vulnerability'

    field :state, VulnerabilityStateEnum, null: true,
          description: "State of the vulnerability (#{::Vulnerability.states.keys.join(', ').upcase})"

    field :severity, VulnerabilitySeverityEnum, null: true,
          description: "Severity of the vulnerability (#{::Vulnerabilities::Occurrence::SEVERITY_LEVELS.keys.join(', ').upcase})"

    field :report_type, VulnerabilityReportTypeEnum, null: true,
          description: "Type of the security report that found the vulnerability (#{::Vulnerabilities::Occurrence::REPORT_TYPES.keys.join(', ').upcase})"

    field :vulnerability_path, GraphQL::STRING_TYPE, null: true,
          description: "URL to the vulnerability's details page",
          resolve: -> (obj, _args, _ctx) { ::Gitlab::Routing.url_helpers.project_security_vulnerability_path(obj.project, obj) }

    field :location, GraphQL::Types::JSON, null: true,
          description: 'The JSON location metadata for the vulnerability. Its format depends on the type of the security scan that found the vulnerability',
          resolve: -> (obj, _args, _ctx) { obj.finding&.location.to_json }

    field :project_fingerprint, GraphQL::STRING_TYPE, null: true,
          description: "Fingerprint used to associate the vulnerability's finding with feedback",
          resolve: -> (obj, _args, _ctx) { obj.finding&.project_fingerprint }

    field :dismissal_path, GraphQL::STRING_TYPE, null: true,
          description: "WHatever",
          resolve: -> (obj, _args, _ctx) { binding.pry; expose_path(GrapePathHelpers::NamedRouteMatcher.api_v4_vulnerabilities_dismiss_path(obj)) }
  end
end
